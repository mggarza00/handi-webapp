user nginx;
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  # Strong compression with proper negotiation
  gzip on;
  gzip_comp_level 6;
  gzip_min_length 1024;
  gzip_vary on; # ensures Vary: Accept-Encoding
  gzip_proxied any;
  gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/xml
    application/json
    image/svg+xml
    font/ttf
    font/otf
    application/vnd.ms-fontobject;

  # Enable Brotli only when the client advertises support
  # Requires ngx_brotli module to be compiled
  brotli on;
  brotli_comp_level 5;
  brotli_static on; # serve precompressed .br if present
  brotli_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/xml
    application/json
    image/svg+xml
    font/ttf
    font/otf
    application/vnd.ms-fontobject;

  server {
    listen 80;
    server_name _;
    root /var/www/handi-webapp;

    # Ensure correct MIME and Vary for CSS
    location ~* \.css$ {
      types { text/css css; }
      default_type text/css;
      add_header Content-Type text/css always;
      add_header Vary "Accept-Encoding" always;
      add_header X-Content-Type-Options nosniff always;
      expires 7d;
      add_header Cache-Control "public, max-age=604800, immutable" always;
    }

    # Static assets
    location /_next/static/ {
      add_header Vary "Accept-Encoding" always;
      expires 30d;
      add_header Cache-Control "public, max-age=2592000, immutable" always;
    }

    location / {
      try_files $uri $uri/ /index.html;
    }
  }
}

