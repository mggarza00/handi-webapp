{"text":"\"use client\";\n\nimport * as React from \"react\";\nimport Image from \"next/image\";\nimport { AnimatePresence, motion } from \"framer-motion\";\nimport { MapPin } from \"lucide-react\";\n\nimport LocationPickerDialog from \"@/components/location/LocationPickerDialog\";\nimport ConditionsCombobox from \"@/components/requests/ConditionsCombobox\";\nimport { useCreateRequestForm } from \"@/components/requests/useCreateRequestForm\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Stepper, type Step } from \"@/components/ui/stepper\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { CITIES } from \"@/lib/cities\";\n\nconst slideVariants = {\n  enter: (dir: 1 | -1) => ({\n    x: dir === 1 ? 40 : -40,\n    opacity: 0,\n  }),\n  center: {\n    x: 0,\n    opacity: 1,\n  },\n  exit: (dir: 1 | -1) => ({\n    x: dir === 1 ? -40 : 40,\n    opacity: 0,\n  }),\n};\n\nfunction isUrl(v: string | null | undefined) {\n  return !!v && (v.startsWith(\"http://\") || v.startsWith(\"https://\") || v.startsWith(\"/\"));\n}\n\nexport type CreateRequestWizardProps = {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess?: (newId?: string) => void;\n};\n\nexport default function CreateRequestWizard({ open, onOpenChange, onSuccess }: CreateRequestWizardProps) {\n  const api = useCreateRequestForm();\n  const {\n    values,\n    errors,\n    submitting,\n    uploading,\n    catMap,\n    loadingCats,\n    addrOpen,\n    addrSuggestions,\n    recentAddrs,\n    coords,\n    openMap,\n  } = api.state;\n  const {\n    title,\n    description,\n    city,\n    category,\n    subcategory,\n    budget,\n    requiredAt,\n    conditionsText,\n    files,\n    address,\n  } = values;\n  const fileInputRef = React.useRef<HTMLInputElement | null>(null);\n  const [stepIdx, setStepIdx] = React.useState(0);\n  const [direction, setDirection] = React.useState<1 | -1>(1);\n  const [filePreviews, setFilePreviews] = React.useState<Array<{ file: File; url: string }>>([]);\n\n  React.useEffect(() => {\n    if (files.length === 0) {\n      setFilePreviews([]);\n      return undefined;\n    }\n    const next = files.map((file) => ({ file, url: URL.createObjectURL(file) }));\n    setFilePreviews(next);\n    return () => {\n      next.forEach(({ url }) => URL.revokeObjectURL(url));\n    };\n  }, [files]);\n\n  const STEPS: Step[] = React.useMemo(\n    () => [\n      { id: \"basic\", label: \"Describe lo que necesitas\" },\n      { id: \"location\", label: \"Ubicación del servicio\" },\n      { id: \"extras\", label: \"Datos adicionales\" },\n    ],\n    [],\n  );\n  const totalSteps = STEPS.length;\n  const activeStepId = STEPS[stepIdx]?.id ?? STEPS[0]?.id;\n\n  const goBack = React.useCallback(() => {\n    setDirection(-1);\n    setStepIdx((prev) => (prev > 0 ? prev - 1 : 0));\n  }, []);\n  const goNext = React.useCallback(() => {\n    setDirection(1);\n    setStepIdx((prev) => (prev < totalSteps - 1 ? prev + 1 : prev));\n  }, [totalSteps]);\n\n  const isLastStep = stepIdx === totalSteps - 1;\n  const trimmedAddress = (address || \"\").trim();\n  const suggestionSource = trimmedAddress.length >= 3 ? addrSuggestions : recentAddrs;\n\n  React.useEffect(() => {\n    if (!open) {\n      setDirection(1);\n      setStepIdx(0);\n    }\n  }, [open]);\n\n  async function onFinish() {\n    await api.handleSubmit({\n      onSuccess: (newId) => {\n        onOpenChange(false);\n        onSuccess?.(newId);\n      },\n    });\n  }\n\n  const isBasicStep = activeStepId === \"basic\";\n  const isLocationStep = activeStepId === \"location\";\n  const isExtrasStep = activeStepId === \"extras\";\n  const bodyRef = React.useRef<HTMLDivElement | null>(null);\n  const [bodyHeight, setBodyHeight] = React.useState<number | null>(null);\n\n  React.useLayoutEffect(() => {\n    if (typeof window === \"undefined\") return;\n    const node = bodyRef.current;\n    if (!node) return;\n    const measure = () => {\n      setBodyHeight(node.getBoundingClientRect().height);\n    };\n    let frame = window.requestAnimationFrame(measure);\n    let resizeObserver: ResizeObserver | null = null;\n    if (\"ResizeObserver\" in window) {\n      resizeObserver = new ResizeObserver(() => {\n        if (frame) window.cancelAnimationFrame(frame);\n        frame = window.requestAnimationFrame(measure);\n      });\n      resizeObserver.observe(node);\n    }\n    return () => {\n      if (frame) window.cancelAnimationFrame(frame);\n      resizeObserver?.disconnect();\n    };\n  }, [\n    activeStepId,\n    title,\n    description,\n    address,\n    conditionsText,\n    budget,\n    requiredAt,\n    files.length,\n    addrSuggestions.length,\n    recentAddrs.length,\n  ]);\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent\n        showCloseButton={false}\n        className=\"max-w-3xl sm:max-w-4xl !rounded-none !border-none !bg-transparent !p-0 !shadow-none\"\n      >\n        <motion.div className=\"w-full rounded-2xl bg-background border shadow-2xl overflow-hidden\">\n          <header className=\"border-b px-6 py-4\">\n            <div className=\"flex items-center justify-between gap-4\">\n              <div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Paso {stepIdx + 1} de {totalSteps}\n                </p>\n                <h2 className=\"text-lg font-semibold leading-tight\">{STEPS[stepIdx].label}</h2>\n              </div>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onOpenChange(false)} aria-label=\"Cerrar\">\n                ×\n              </Button>\n            </div>\n            <div className=\"mt-4\">\n              <Stepper steps={STEPS} currentStepIndex={stepIdx} />\n            </div>\n          </header>\n\n          <motion.div\n            className=\"px-6 py-5 overflow-hidden\"\n            initial={false}\n            animate={{ height: bodyHeight ?? \"auto\" }}\n            transition={{ duration: 0.25, ease: \"easeInOut\" }}\n          >\n            <div className=\"max-h-[70vh] overflow-y-auto\">\n              <div ref={bodyRef}>\n                <AnimatePresence initial={false} mode=\"sync\" custom={direction}>\n                  <motion.div\n                    key={stepIdx}\n                    custom={direction}\n                    variants={slideVariants}\n                    initial=\"enter\"\n                    animate=\"center\"\n                    exit=\"exit\"\n                    transition={{ type: \"tween\", duration: 0.25 }}\n                    className=\"space-y-6\"\n                  >\n                {isBasicStep && (\n                  <section className=\"space-y-4\">\n                    <div className=\"space-y-1.5\">\n                      <Label>Título</Label>\n                      <Input\n                        data-testid=\"request-title\"\n                        value={title}\n                        onChange={(e) => api.setTitle(e.target.value)}\n                        placeholder=\"ej. Reparación de fuga en baño\"\n                        required\n                      />\n                      {errors?.title && <p className=\"text-xs text-red-600\">{errors.title}</p>}\n                    </div>\n                    <div className=\"space-y-1.5\">\n                      <Label>Descripción</Label>\n                      <Textarea\n                        data-testid=\"request-desc\"\n                        rows={4}\n                        value={description}\n                        onChange={(e) => api.setDescription(e.target.value)}\n                        placeholder=\"Describe lo que necesitas…\"\n                      />\n                      {errors?.description && <p className=\"text-xs text-red-600\">{errors.description}</p>}\n                    </div>\n                    <div className=\"grid grid-cols-1 gap-3 md:grid-cols-2\">\n                      <div className=\"space-y-1.5\">\n                        <Label>Categoría</Label>\n                        <Select value={category} onValueChange={(v) => api.setCategory(v)}>\n                          <SelectTrigger data-testid=\"request-category\">\n                            <SelectValue placeholder={loadingCats ? \"Cargando…\" : \"Selecciona…\"} />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {api.categoriesList.map((c) => (\n                              <SelectItem key={c} value={c}>\n                                {c}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {errors?.category && <p className=\"text-xs text-red-600\">{errors.category}</p>}\n                      </div>\n                      <div className=\"space-y-1.5\">\n                        <Label>Subcategoría</Label>\n                        <Select value={subcategory} onValueChange={(v) => api.setSubcategory(v)}>\n                          <SelectTrigger disabled={!category || (catMap[category]?.length ?? 0) === 0}>\n                            <SelectValue\n                              placeholder={\n                                !category\n                                  ? \"Elige una categoría primero\"\n                                  : (catMap[category]?.length ?? 0) > 0\n                                  ? \"Selecciona…\"\n                                  : \"Sin subcategorías\"\n                              }\n                            />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {api.subcatOptions.map((s) => (\n                              <SelectItem key={s.value} value={s.value}>\n                                <span className=\"inline-flex items-center gap-2\">\n                                  {s.icon ? (\n                                    isUrl(s.icon) ? (\n                                      <Image\n                                        src={s.icon}\n                                        alt=\"\"\n                                        width={16}\n                                        height={16}\n                                        className=\"h-4 w-4 object-contain\"\n                                        unoptimized\n                                      />\n                                    ) : (\n                                      <span className=\"text-base leading-none\">{s.icon}</span>\n                                    )\n                                  ) : null}\n                                  <span>{s.label}</span>\n                                </span>\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {errors?.subcategory && <p className=\"text-xs text-red-600\">{errors.subcategory}</p>}\n                      </div>\n                    </div>\n                  </section>\n                )}\n\n                {isLocationStep && (\n                  <section className=\"space-y-4\">\n                    <div className=\"space-y-1.5\">\n                      <Label>Dirección</Label>\n                      <div className=\"flex items-center gap-2\">\n                        <Input\n                          value={address}\n                          onChange={(e) => api.setAddress(e.target.value)}\n                          placeholder=\"Calle y número, colonia, CP\"\n                          aria-label=\"Dirección\"\n                          className={\"flex-1 \" + (errors?.address_line ? \"border-red-600 focus-visible:ring-red-600\" : \"\")}\n                          aria-invalid={errors?.address_line ? true : undefined}\n                          onFocus={() => {\n                            const q = (address || \"\").trim();\n                            if (q.length >= 3) {\n                              api.setAddrOpen(true);\n                              api.debouncedFetchAddr(address || \"\");\n                            }\n                          }}\n                          onBlur={() => {\n                            setTimeout(() => api.setAddrOpen(false), 120);\n                          }}\n                        />\n                        <Button type=\"button\" variant=\"outline\" onClick={() => api.setOpenMap(true)} aria-label=\"Abrir mapa\">\n                          <MapPin size={18} />\n                        </Button>\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          onClick={async () => {\n                            if (!(\"geolocation\" in navigator)) return;\n                            try {\n                              const pos = await new Promise<GeolocationPosition>((resolve, reject) => {\n                                const id = window.setTimeout(() => reject(new Error(\"GEO_TIMEOUT\")), 6000);\n                                navigator.geolocation.getCurrentPosition(\n                                  (p) => {\n                                    window.clearTimeout(id);\n                                    resolve(p);\n                                  },\n                                  (e) => {\n                                    window.clearTimeout(id);\n                                    reject(e);\n                                  },\n                                  { enableHighAccuracy: false, timeout: 5000, maximumAge: 30000 },\n                                );\n                              });\n                              const lat = Number(pos.coords.latitude);\n                              const lon = Number(pos.coords.longitude);\n                              const r = await fetch(\n                                `/api/geocode?lat=${encodeURIComponent(String(lat))}&lng=${encodeURIComponent(String(lon))}`,\n                                { cache: \"no-store\", headers: { Accept: \"application/json; charset=utf-8\" } },\n                              );\n                              const j = await r.json().catch(() => ({}));\n                              const addrLine = (j?.address_line || j?.address || \"\") as string;\n                              const cityRes = (j?.city || \"\") as string;\n                              api.pickAddress({ address: addrLine || address || \"\", city: cityRes || undefined, lat, lon });\n                            } catch {\n                              /* ignore */\n                            }\n                          }}\n                        >\n                          Usar mi ubicación\n                        </Button>\n                      </div>\n                      {errors?.address_line ? (\n                        <p className=\"mt-1 text-xs text-red-600\">Favor de indicar Dirección</p>\n                      ) : null}\n                      {addrOpen &&\n                      ((trimmedAddress.length >= 3 && addrSuggestions.length > 0) ||\n                        (trimmedAddress.length === 0 && recentAddrs.length > 0)) ? (\n                        <div className=\"mt-2 max-h-60 w-full overflow-auto rounded-md border bg-white shadow-sm\">\n                          {suggestionSource.map((it, idx) => {\n                            const isSaved = Boolean(it.id);\n                            const meta = [it.postal_code, it.city].filter(Boolean).join(\", \");\n                            return (\n                              <div\n                                key={(it.id || it.address) + String(idx)}\n                                className=\"flex items-center gap-2 px-2 py-2 hover:bg-slate-50\"\n                              >\n                                <button\n                                  type=\"button\"\n                                  onMouseDown={(e) => {\n                                    e.preventDefault();\n                                    api.pickAddress(it);\n                                  }}\n                                  className=\"flex-1 truncate text-left\"\n                                  title={it.address}\n                                >\n                                  <div className=\"min-w-0\">\n                                    <div className=\"truncate\">{it.address}</div>\n                                    {meta ? <div className=\"truncate text-xs text-slate-500\">{meta}</div> : null}\n                                  </div>\n                                </button>\n                                {isSaved ? (\n                                  <button\n                                    type=\"button\"\n                                    className=\"ml-auto px-1 py-1 text-xs text-red-600 hover:underline\"\n                                    onMouseDown={async (e) => {\n                                      e.preventDefault();\n                                      try {\n                                        if (!it.id) return;\n                                        await fetch(`/api/addresses/book/${encodeURIComponent(String(it.id))}`, {\n                                          method: \"DELETE\",\n                                          credentials: \"include\",\n                                        });\n                                      } catch {\n                                        /* ignore */\n                                      }\n                                    }}\n                                  >\n                                    Quitar\n                                  </button>\n                                ) : null}\n                              </div>\n                            );\n                          })}\n                        </div>\n                      ) : null}\n                      <div className=\"space-y-1.5\">\n                        <Label>Ciudad</Label>\n                        <Select\n                          value={city}\n                          onValueChange={(v) => {\n                            api.setCityTouched(true);\n                            api.setCity(v);\n                          }}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecciona ciudad\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {CITIES.map((c) => (\n                              <SelectItem key={c} value={c}>\n                                {c}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {errors?.city && <p className=\"text-xs text-red-600\">{errors.city}</p>}\n                      </div>\n                    </div>\n                  </section>\n                )}\n\n                {isExtrasStep && (\n                  <section className=\"space-y-4\">\n                    <div className=\"space-y-1.5\">\n                      <Label>Fecha requerida</Label>\n                      <div className=\"w-[18ch] md:w-[16ch]\">\n                        <Input\n                          type=\"date\"\n                          value={requiredAt}\n                          onChange={(e) => api.setRequiredAt(e.target.value)}\n                          className=\"w-full text-center\"\n                        />\n                      </div>\n                      {errors?.required_at && <p className=\"text-xs text-red-600\">{errors.required_at}</p>}\n                    </div>\n                    <div className=\"space-y-1.5\">\n                      <Label>Condiciones</Label>\n                      <p className=\"text-xs text-slate-500\">Selecciona o escribe condiciones relevantes (máx. 10).</p>\n                      <ConditionsCombobox value={conditionsText} onChange={(v) => api.setConditionsText(v)} />\n                      {errors?.conditions && <p className=\"text-xs text-red-600\">{errors.conditions}</p>}\n                    </div>\n                    <div className=\"space-y-1.5\">\n                      <Label>Presupuesto estimado</Label>\n                      <div className=\"relative w-[35%]\">\n                        <span className=\"pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 text-sm text-slate-500\">\n                          $\n                        </span>\n                        <Input\n                          type=\"number\"\n                          value={budget}\n                          onChange={(e) => api.setBudget(e.target.value === \"\" ? \"\" : Number(e.target.value))}\n                          min={0}\n                          step={100}\n                          placeholder=\"800\"\n                          className=\"pl-6 pr-14\"\n                        />\n                        <span className=\"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-xs text-slate-500\">\n                          MXN\n                        </span>\n                      </div>\n                      {errors?.budget && <p className=\"text-xs text-red-600\">{errors.budget}</p>}\n                    </div>\n                    <div className=\"space-y-1.5\">\n                      <Label>Imágenes del sitio (máx 5 MB c/u)</Label>\n                      <p className=\"text-xs text-slate-500\">Permite hasta 5 imágenes.</p>\n                      <input\n                        ref={fileInputRef}\n                        className=\"sr-only\"\n                        type=\"file\"\n                        accept=\"image/*\"\n                        multiple\n                        onChange={(e) => {\n                          const incoming = Array.from(e.currentTarget.files ?? []);\n                          api.addFiles(incoming);\n                          e.currentTarget.value = \"\";\n                        }}\n                      />\n                      <div className=\"flex flex-wrap gap-2\">\n                        {filePreviews.map((preview, idx) => (\n                          <div\n                            key={`${preview.file.name}-${preview.file.size}-${preview.file.lastModified}-${idx}`}\n                            className=\"relative h-20 w-20 overflow-hidden rounded border border-slate-200 bg-white\"\n                          >\n                            <Image\n                              src={preview.url}\n                              alt={preview.file.name}\n                              width={80}\n                              height={80}\n                              className=\"h-full w-full object-cover\"\n                              unoptimized\n                            />\n                            <button\n                              type=\"button\"\n                              title=\"Quitar\"\n                              className=\"absolute right-1 top-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-black/70 text-white\"\n                              onClick={() => api.removeFileAt(idx)}\n                            >\n                              ×\n                            </button>\n                          </div>\n                        ))}\n                        {files.length < 5 && (\n                          <button\n                            type=\"button\"\n                            onClick={() => fileInputRef.current?.click()}\n                            className=\"flex h-20 w-20 items-center justify-center rounded border border-dashed border-slate-300 text-slate-500 hover:bg-slate-50\"\n                            title=\"Agregar imagen\"\n                          >\n                            +\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  </section>\n                )}\n              </motion.div>\n            </AnimatePresence>\n          </div>\n        </div>\n          </motion.div>\n\n          <footer className=\"flex flex-wrap items-center justify-between gap-3 border-t px-6 py-4\">\n            <Button type=\"button\" variant=\"ghost\" disabled={stepIdx === 0} onClick={goBack}>\n              Atrás\n            </Button>\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <Button variant=\"outline\" type=\"button\" onClick={() => onOpenChange(false)}>\n                Cancelar\n              </Button>\n              {!isLastStep && (\n                <Button type=\"button\" onClick={goNext}>\n                  Continuar\n                </Button>\n              )}\n              {isLastStep && (\n                <Button type=\"button\" onClick={onFinish} disabled={submitting || uploading} data-testid=\"post-request\">\n                  {submitting ? \"Creando\" : \"Crear solicitud\"}\n                </Button>\n              )}\n            </div>\n          </footer>\n        </motion.div>\n      </DialogContent>\n\n      <LocationPickerDialog\n        open={openMap}\n        onOpenChange={api.setOpenMap}\n        initialCoords={coords}\n        initialAddress={address || null}\n        onConfirm={(lat, lon, addr) => {\n          api.pickAddress({ address: addr, lat, lon });\n          api.setOpenMap(false);\n        }}\n      />\n    </Dialog>\n  );\n}\n"}